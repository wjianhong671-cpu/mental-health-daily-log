<view style="padding:20px;background:#f6f6f6;min-height:100vh;">

<view style="font-size:18px;font-weight:800;margin-bottom:6px;">用药方案</view>
<view style="color:#666;font-size:12px;line-height:1.6;margin-bottom:14px;">
  这个页面通常只需要在医生调整方案时改一次。之后每天记录时，我们只问你：今天是否按计划服药、有没有不适/副作用。
</view>

<!-- 药物列表 -->
<view style="background:#fff;border:1px solid #eee;border-radius:16px;padding:14px;margin-bottom:14px;">
  <view style="font-size:16px;font-weight:800;margin-bottom:10px;">药物清单</view>

  <block wx:for="{{meds}}" wx:key="idx">
    <view style="border:1px solid #eee;border-radius:14px;padding:12px;margin-bottom:12px;">

      <view style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <view style="font-weight:800;">第 {{index + 1}} 种药</view>
        <button size="mini" plain="true" data-idx="{{index}}" bindtap="removeMed"
          style="color:#d32f2f;border-color:#f1c7c7;">
          删除
        </button>
      </view>

      <!-- 选择药名 -->
      <view style="margin-bottom:10px;">
        <view style="font-size:13px;font-weight:700;margin-bottom:6px;">选择药物</view>
        <picker mode="selector" range="{{medOptions}}" range-key="name"
          data-idx="{{index}}" bindchange="onMedPick">
          <view style="padding:12px;border:1px solid #eee;border-radius:12px;">
            {{item.name || '点击选择药物'}}
          </view>
        </picker>
        <view style="color:#999;font-size:12px;margin-top:6px;">
          先做示例列表，后续我们再把常见精神科药物补全。
        </view>
      </view>

      <!-- 每日总剂量 -->
      <view style="margin-bottom:10px;">
        <view style="font-size:13px;font-weight:700;margin-bottom:6px;">每日总剂量（mg/天）</view>
        <input type="number" placeholder="例如 200"
          value="{{item.doseMg}}"
          data-idx="{{index}}"
          bindinput="onDoseInput"
          style="padding:12px;border:1px solid #eee;border-radius:12px;" />
      </view>

      <!-- 服用时间 -->
      <view style="margin-bottom:6px;">
        <view style="font-size:13px;font-weight:700;margin-bottom:6px;">服用时间（可多选）</view>
        <checkbox-group data-idx="{{index}}" bindchange="onTimesChange">
          <label style="display:block;padding:6px 0;">
            <checkbox value="morning" checked="{{item.timesMap.morning}}" /> 早
          </label>
          <label style="display:block;padding:6px 0;">
            <checkbox value="noon" checked="{{item.timesMap.noon}}" /> 中
          </label>
          <label style="display:block;padding:6px 0;">
            <checkbox value="night" checked="{{item.timesMap.night}}" /> 晚
          </label>
        </checkbox-group>
      </view>

    </view>
  </block>

  <button type="default" plain="true" bindtap="addMed"
    style="border-radius:14px;border-color:#cfe8d1;color:#2e7d32;font-weight:700;">
    + 添加一种药
  </button>
</view>

<!-- 下次复诊日期 -->
<view style="background:#fff;border:1px solid #eee;border-radius:16px;padding:14px;margin-bottom:14px;">
  <view style="font-size:16px;font-weight:800;margin-bottom:10px;">下次复诊日期</view>

  <picker mode="date" value="{{nextVisitDate}}" bindchange="onNextVisitChange">
    <view style="padding:12px;border:1px solid #eee;border-radius:12px;">
      {{nextVisitDate || '点击选择日期'}}
    </view>
  </picker>

  <view style="color:#999;font-size:12px;margin-top:8px;line-height:1.6;">
    选择后，后续可以基于这个日期做“复诊前提醒/检查清单”（第二优先级）。
  </view>
</view>

<!-- 保存按钮 -->
<view style="margin-bottom:14px;">
  <button type="primary" bindtap="savePlan"
    style="border-radius:14px;font-weight:800;">
    保存用药方案
  </button>
</view>

<!-- 当前已保存方案 -->
<view style="background:#fff;border:1px solid #eee;border-radius:16px;padding:14px;">
  <view style="font-size:16px;font-weight:800;margin-bottom:10px;">当前已保存方案</view>

  <block wx:if="{{!savedPlan}}">
    <view style="color:#999;">暂无已保存方案</view>
  </block>

  <block wx:else>
    <block wx:for="{{savedPlan.meds}}" wx:key="idx">
      <view style="padding:10px 0;border-bottom:1px solid #f2f2f2;">
        <view>药物：{{item.name}}</view>
        <view>剂量：{{item.doseMg}} mg/天</view>
        <view>时间：{{item.timesText}}</view>
      </view>
    </block>

    <view style="margin-top:10px;">下次复诊：{{savedPlan.nextVisitDate || '未填写'}}</view>
    <view style="color:#999;font-size:12px;margin-top:6px;">更新于：{{savedPlan.updatedTimeText || ''}}</view>
  </block>
</view>

<view style="height:18px;"></view>
</view>